name: Generate PDF on Push

on:
  push:
    branches:
    - master
    paths:
    - '**/**.md'

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Pandoc and LaTeX with CJK support
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-fonts-extra fonts-noto-cjk texlive-lang-cjk

    - name: Create PDFs directory
      run: mkdir -p pdfs
      
    - name: Generate PDFs
      run: |
        find . -name "*.md" -print0 | while IFS= read -r -d $'\0' file; do
          filename=$(basename -- "$file")
          filename_no_ext="${filename%.*}"
          echo "Processing: $file -> pdfs/${filename_no_ext}.pdf"
          pandoc --pdf-engine=xelatex \
          -V CJKmainfont="Noto Sans CJK SC" \
          -V geometry:margin=1in \
          -V linkcolor:blue \
          -s -o "pdfs/${filename_no_ext}.pdf" "$file" || {
          echo "Error processing $file, skipping..."
          continue
          }
        done

    - name: List generated PDFs
      run: ls -l pdfs/

    - name: Archive PDFs
      run: |
        zip -r release_pdfs_${{ github.run_number }}.zip pdfs/

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.COMMON }}
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: "Release generated by GitHub Actions"
        draft: false
        prerelease: false
        files: release_pdfs_${{ github.run_numberÂ }}.zip
